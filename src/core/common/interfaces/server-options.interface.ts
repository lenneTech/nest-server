import { GqlModuleOptions } from '@nestjs/graphql';
import { JwtModuleOptions } from '@nestjs/jwt';
import { ServeStaticOptions } from '@nestjs/platform-express/interfaces/serve-static-options.interface';
import * as SMTPTransport from 'nodemailer/lib/smtp-transport';
import { MongooseModuleOptions } from '@nestjs/mongoose/dist/interfaces/mongoose-options.interface';

/**
 * Options for the server
 */
export interface IServerOptions {
  /**
   * Environment
   * e.g. 'development'
   */
  env?: string;

  /**
   * Configuration of the GraphQL module
   * see https://docs.nestjs.com/graphql/quick-start
   * and https://www.apollographql.com/docs/apollo-server/api/apollo-server/
   */
  graphQl?: {
    /**
     * Autogenerated schema file
     * e.g. 'schema.gql'
     */
    autoSchemaFile?: string;

    /**
     * Function for context manipulation
     * e.g. ({ req }) => ({ req })
     */
    context?: (context: { [key: string]: any; req: any }) => { [key: string]: any; req: any };

    /**
     * Enables and disables development mode helpers of apollo
     * e.g. true
     */
    debug?: boolean;

    /**
     * Determines whether or not to install subscription handlers
     * e.g. true
     */
    installSubscriptionHandlers?: boolean;

    /**
     * Enables and disables schema introspection
     * e.g. true
     */
    introspection?: boolean;
  } & GqlModuleOptions;

  /**
   * Configuration of JavaScript Web Token (JWT) module
   */
  jwt?: {
    /**
     * Private key
     */
    privateKey?: string;

    /**
     * Public key
     */
    publicKey?: string;

    /**
     * Secret to encrypt the JWT
     */
    secret?: string;

    /**
     * JWT Provider
     * See https://github.com/mikenicholson/passport-jwt/blob/master/README.md#configure-strategy
     */
    secretOrKeyProvider?: (
      request: Record<string, any>,
      rawJwtToken: string,
      done: (err: any, secret: string) => any
    ) => any;

    /**
     * Alias of secret (for backwards compatibility)
     */
    secretOrPrivateKey?: string;
  } & JwtModuleOptions;

  /**
   * Port number of the server
   * e.g. 8080
   */
  port?: number;

  /**
   * SMTP and template configuration for sending emails
   */
  email?: {
    /**
     * SMTP configuration for nodemailer
     */
    smtp?: SMTPTransport | SMTPTransport.Options | string;

    /**
     * Verification link for email
     */
    verificationLink?: string;

    /**
     * Password reset link for email
     */
    passwordResetLink?: string;

    /**
     * Data for default sender
     */
    defaultSender?: {
      /**
       * Default email for sending emails
       */
      email?: string;

      /**
       * Default name for sending emails
       */
      name?: string;
    };
  };

  /**
   * Configuration for Mongoose
   */
  mongoose?: { uri: string; options?: MongooseModuleOptions };

  /**
   * Configuration for useStaticAssets
   */
  staticAssets?: {
    /**
     * Root directory for static assets
     * e.g. join(__dirname, '..', 'public')
     */
    path?: string;

    /**
     * Additional options for useStaticAssets
     * e.g. {prefix: '/public/'}
     */
    options?: ServeStaticOptions;
  };

  /**
   * Templates
   */
  templates?: {
    /**
     * Directory for templates
     *  e.g. join(__dirname, '..', 'templates')
     */
    path?: string;

    /**
     * View engine
     * e.g. 'ejs'
     */
    engine?: string;
  };
}
