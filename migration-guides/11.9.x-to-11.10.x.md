# Migration Guide: 11.9.x → 11.10.x

## Overview

| Category | Details |
|----------|---------|
| **Breaking Changes** | 1. `trustedOrigins` now required when Passkey enabled (TypeScript compile-time check) |
| **New Features** | Logging helpers, improved session lookup, enhanced cookie handling, native Better Auth plugin endpoints, **BetterAuthTokenService**, **registerRolesGuardGlobally** for IAM-only setups |
| **Bugfixes** | Session token forwarding to Better Auth plugins, **RolesGuard now enforced in IAM-only mode** |
| **Migration Effort** | Low (~10 minutes) - Affects projects using Passkey or IAM-only setups |

---

## Quick Migration

### Projects WITHOUT Passkey

```bash
# Update package
npm install @lenne.tech/nest-server@11.10.x

# Verify build
npm run build

# Run tests
npm test
```

**That's it!** No code changes required.

### Projects WITH Passkey

If you use `passkey: true` in your BetterAuth config, you must now provide `trustedOrigins`:

```typescript
// config.env.ts - BEFORE (11.9.x)
betterAuth: {
  passkey: true,  // This worked without trustedOrigins
}

// config.env.ts - AFTER (11.10.x)
betterAuth: {
  passkey: true,
  trustedOrigins: ['http://localhost:3001', 'https://app.example.com'],  // REQUIRED
}
```

### IAM-only Projects (Security Fix)

If you use the 1-parameter `CoreModule.forRoot(environment)` signature (IAM-only, no Legacy Auth), add `registerRolesGuardGlobally: true`:

```typescript
// server.module.ts - BEFORE (11.9.x)
CoreBetterAuthModule.forRoot({
  config: environment.betterAuth,
})

// server.module.ts - AFTER (11.10.x)
CoreBetterAuthModule.forRoot({
  config: environment.betterAuth,
  registerRolesGuardGlobally: true,  // IMPORTANT: Ensures @Roles() decorators work
})
```

**Why:** Without this option, `@Roles()` decorators are not enforced in IAM-only mode, potentially exposing protected endpoints.

---

## What's New in 11.10.x

### 1. TypeScript Compile-Time Validation for Passkey CORS

The `IBetterAuth` type is now a **Discriminated Union** that enforces `trustedOrigins` when Passkey is enabled.

**Why this change?**
Passkey (WebAuthn) uses `credentials: 'include'` for API calls. Browsers don't allow CORS wildcard `*` with credentials, so explicit origins must be configured. This was previously a runtime error - now it's caught at compile time.

```typescript
// TypeScript ERROR: Property 'trustedOrigins' is missing
const config: IBetterAuth = {
  passkey: true,
  // ❌ Compile error!
};

// CORRECT: trustedOrigins provided
const config: IBetterAuth = {
  passkey: true,
  trustedOrigins: ['http://localhost:3001'],  // ✅
};

// CORRECT: No Passkey, trustedOrigins optional
const config: IBetterAuth = {
  twoFactor: true,
  // trustedOrigins is optional when passkey is disabled
};
```

### 2. Logging Helper for Secure Logging

New helper functions for safely logging sensitive data (GDPR compliant):

```typescript
import { maskToken, maskEmail, maskCookieHeader, isProduction } from '@lenne.tech/nest-server';

// Mask tokens: 'abc123xyz789' → 'abc1...9789'
this.logger.debug(`Token: ${maskToken(token)}`);

// Mask emails: 'john.doe@example.com' → 'jo***@example.com'
this.logger.debug(`User: ${maskEmail(user.email)}`);

// Mask cookie headers: 'session=abc123; token=xyz' → 'session=***; token=***'
this.logger.debug(`Cookies: ${maskCookieHeader(req.headers.cookie)}`);

// Conditional logging for non-production only
if (!isProduction()) {
  this.logger.debug('Debug info...');
}
```

### 3. Improved Session Lookup Performance

The `getSessionByToken()` method now uses a MongoDB aggregation pipeline for single-query session+user lookup, improving performance and handling both ObjectId and string userId formats automatically.

### 4. Enhanced Cookie Handling for Plugin Compatibility

Session tokens are now set in multiple cookies to ensure compatibility with Better Auth plugins (especially Passkey):

| Cookie | Purpose |
|--------|---------|
| `token` | nest-server compatibility |
| `{basePath}.session_token` | Better Auth native (e.g., `iam.session_token`) |
| `better-auth.session_token` | Legacy Better Auth |

### 5. Native Better Auth Plugin Endpoints

2FA and Passkey endpoints now use Better Auth's native plugin handlers, providing more features:

**Two-Factor Authentication (2FA):**

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/iam/two-factor/enable` | POST | Enable 2FA, get TOTP URI |
| `/iam/two-factor/disable` | POST | Disable 2FA |
| `/iam/two-factor/verify-totp` | POST | Verify TOTP code |
| `/iam/two-factor/generate-backup-codes` | POST | Generate backup codes |
| `/iam/two-factor/verify-backup-code` | POST | Verify backup code |

**Passkey (WebAuthn):**

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/iam/passkey/generate-register-options` | POST | Get WebAuthn registration options |
| `/iam/passkey/verify-registration` | POST | Verify and store passkey |
| `/iam/passkey/generate-authenticate-options` | POST | Get WebAuthn authentication options |
| `/iam/passkey/verify-authentication` | POST | Verify passkey authentication |
| `/iam/passkey/list-user-passkeys` | POST | List user's passkeys |
| `/iam/passkey/delete-passkey` | POST | Delete a passkey |
| `/iam/passkey/update-passkey` | POST | Update passkey name |

### 6. BetterAuthTokenService

New centralized service for token extraction and user loading in BetterAuth authentication.

**What the service provides:**
- Token extraction from Authorization header or cookies
- JWT token verification via BetterAuth
- Session token verification via database lookup
- User loading from MongoDB with `hasRole()` capability

**Benefits:**
- Consolidates token verification logic that was previously duplicated in AuthGuard and RolesGuard
- Lazy resolution: Guards use `ModuleRef.get()` with `{ strict: false }` for optional dependencies
- Improved testability and maintainability

```typescript
import { BetterAuthTokenService } from '@lenne.tech/nest-server';

// In a guard or service
const { token, source } = this.tokenService.extractTokenFromRequest(request);
if (token) {
  const user = await this.tokenService.verifyAndLoadUser(token);
  if (user) {
    request.user = user;
  }
}
```

### 7. IAM-only Mode Support (registerRolesGuardGlobally)

New option `registerRolesGuardGlobally` in `CoreBetterAuthModule.forRoot()` for IAM-only setups.

**Problem:**
In IAM-only setups (CoreModule.forRoot with only 1 parameter), CoreAuthModule is not imported. CoreAuthModule normally registers the RolesGuard globally. Without this global registration, `@Roles()` decorators are not automatically enforced.

**Solution:**
```typescript
// server.module.ts - IAM-only Setup
@Module({
  imports: [
    CoreModule.forRoot(environment),  // 1-parameter signature = IAM-only
    CoreBetterAuthModule.forRoot({
      config: environment.betterAuth,
      registerRolesGuardGlobally: true,  // RolesGuard is registered globally
    }),
  ],
})
export class ServerModule {}
```

**When to use:**
- `registerRolesGuardGlobally: true` - For IAM-only setups (1-parameter CoreModule.forRoot)
- `registerRolesGuardGlobally: false` (default) - For Legacy + IAM setups (3-parameter CoreModule.forRoot)

---

## Breaking Changes

### 1. `trustedOrigins` Required for Passkey

**Impact:** Projects using `passkey: true` without `trustedOrigins`

**Symptom:** TypeScript compile error:
```
Property 'trustedOrigins' is missing in type '{ passkey: true; }' but required in type 'IBetterAuthWithPasskey'.
```

**Before (11.9.x):**
```typescript
betterAuth: {
  passkey: true,
  // trustedOrigins was optional (caused runtime CORS errors)
}
```

**After (11.10.x):**
```typescript
betterAuth: {
  passkey: true,
  trustedOrigins: ['http://localhost:3001', 'https://app.example.com'],
}
```

### 2. 2FA Endpoint Changes

**Impact:** Projects calling 2FA endpoints directly

The endpoint for verifying TOTP codes changed:

| Before (11.9.x) | After (11.10.x) |
|-----------------|-----------------|
| `POST /iam/two-factor/verify` | `POST /iam/two-factor/verify-totp` |

Additionally, new endpoints are available for backup codes.

---

## Bugfixes

### 2FA Session Token Cookie Handling

**Fixed Issue:** When signing in with 2FA enabled, the temporary session token was not being set as a cookie. This caused the 2FA verification step (`/iam/two-factor/verify-totp`) to fail with 401 Unauthorized because the browser couldn't authenticate the request.

**What was happening:**
1. User signs in with email/password
2. Server returns `requiresTwoFactor: true` but no cookie was set
3. User enters TOTP code
4. Request fails because there's no session token to identify the 2FA flow

**What's fixed:**
1. User signs in with email/password
2. Server returns `requiresTwoFactor: true` AND sets the temporary session token as a cookie
3. User enters TOTP code
4. Browser automatically sends the session cookie → verification succeeds

**No action required** - this is a bugfix that improves 2FA functionality without requiring any code changes.

### RolesGuard Enforcement in IAM-only Mode

**Fixed Issue:** In IAM-only setups (CoreModule.forRoot with 1 parameter), `@Roles()` decorators were not automatically enforced because the RolesGuard was not globally registered.

**Symptom:** Endpoints with `@Roles(RoleEnum.ADMIN)` were accessible without authentication.

**Cause:** CoreAuthModule (which globally registers the RolesGuard) is not imported in IAM-only setups.

**Solution:** Use the new option `registerRolesGuardGlobally: true` in CoreBetterAuthModule.forRoot():

```typescript
CoreBetterAuthModule.forRoot({
  config: environment.betterAuth,
  registerRolesGuardGlobally: true,
})
```

**Important:** All IAM-only projects should add this option to ensure `@Roles()` decorators are correctly enforced.

---

## Detailed Migration Steps

### Step 1: Update Package

```bash
npm install @lenne.tech/nest-server@11.10.x
```

### Step 2: Add trustedOrigins (If Using Passkey)

If you have `passkey: true` in your config, add `trustedOrigins`:

```typescript
// config.env.ts
betterAuth: {
  passkey: true,
  trustedOrigins: [
    'http://localhost:3001',      // Development frontend
    'https://app.example.com',    // Production frontend
  ],
}
```

### Step 3: Update 2FA API Calls (If Using 2FA)

If your frontend calls the 2FA verify endpoint, update the path:

```typescript
// Before
await fetch('/iam/two-factor/verify', { body: { code: '123456' } });

// After
await fetch('/iam/two-factor/verify-totp', { body: { code: '123456' } });
```

### Step 4: Add registerRolesGuardGlobally (If IAM-only Setup)

If you use the 1-parameter `CoreModule.forRoot(environment)` signature (without Legacy Auth), add the `registerRolesGuardGlobally` option:

```typescript
// server.module.ts
CoreBetterAuthModule.forRoot({
  config: environment.betterAuth,
  registerRolesGuardGlobally: true,  // Required for IAM-only setups
})
```

**How to check if you're IAM-only:**
- 1-parameter: `CoreModule.forRoot(environment)` → IAM-only, needs `registerRolesGuardGlobally: true`
- 3-parameter: `CoreModule.forRoot(CoreAuthService, AuthModule.forRoot(...), environment)` → Legacy + IAM, no change needed

### Step 5: Verify Build and Tests

```bash
npm run build
npm test
```

---

## Compatibility Notes

### Existing Projects Without Passkey

No changes required. The migration is seamless.

### Existing Projects With 2FA Only

No breaking changes for basic 2FA usage. The new endpoints provide additional features (backup codes) but the core flow remains the same.

### Custom BetterAuthController Extensions

If you extend `CoreBetterAuthController`, note that the `handleBetterAuthPlugins()` method is now used for plugin endpoints. Your existing overrides should continue to work.

---

## Troubleshooting

### TypeScript Error: trustedOrigins Missing

**Symptom:**
```
Property 'trustedOrigins' is missing in type '{ passkey: true; }'
```

**Solution:** Add `trustedOrigins` array to your betterAuth config:
```typescript
betterAuth: {
  passkey: true,
  trustedOrigins: ['http://localhost:3001'],
}
```

### CORS Error with Passkey

**Symptom:** Browser console shows CORS error when using Passkey

**Solution:** Ensure `trustedOrigins` includes your frontend URL (including protocol and port):
```typescript
trustedOrigins: ['http://localhost:3001'],  // Include port!
```

### 2FA Verify Returns 404

**Symptom:** `POST /iam/two-factor/verify` returns 404

**Solution:** Update to new endpoint: `POST /iam/two-factor/verify-totp`

### Debug Logging Not Appearing

**Symptom:** Debug logs missing in development

**Solution:** Debug logs are now suppressed in production. Ensure `NODE_ENV` is not set to `production` during development.

### Protected Endpoints Accessible Without Authentication (IAM-only)

**Symptom:** Endpoints with `@Roles(RoleEnum.ADMIN)` are accessible without authentication in IAM-only setups.

**Cause:** RolesGuard is not globally registered when using 1-parameter `CoreModule.forRoot()`.

**Solution:** Add `registerRolesGuardGlobally: true` to CoreBetterAuthModule:
```typescript
CoreBetterAuthModule.forRoot({
  config: environment.betterAuth,
  registerRolesGuardGlobally: true,
})
```

---

## Module Documentation

### BetterAuth Module

- **README:** [src/core/modules/better-auth/README.md](../src/core/modules/better-auth/README.md)
- **Integration Checklist:** [src/core/modules/better-auth/INTEGRATION-CHECKLIST.md](../src/core/modules/better-auth/INTEGRATION-CHECKLIST.md)
- **Reference Implementation:** `src/server/modules/better-auth/`

---

## New Exports

The following are now exported from `@lenne.tech/nest-server`:

```typescript
// Logging helpers (new)
export { isProduction, maskCookieHeader, maskEmail, maskId, maskSensitive, maskToken } from './core/common/helpers/logging.helper';

// BetterAuth types (updated)
export { IBetterAuth, IBetterAuthWithPasskey, IBetterAuthWithoutPasskey } from './core/common/interfaces/server-options.interface';

// BetterAuthTokenService (new)
export { BetterAuthTokenService, TokenExtractionResult } from './core/modules/better-auth/better-auth-token.service';
```

---

## References

- [BetterAuth README](../src/core/modules/better-auth/README.md)
- [BetterAuth Integration Checklist](../src/core/modules/better-auth/INTEGRATION-CHECKLIST.md)
- [nest-server-starter](https://github.com/lenneTech/nest-server-starter) (reference implementation)
- [Better Auth Documentation](https://www.better-auth.com/docs)
